<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      overflow: hidden;
      background: #000000;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    body, html {
      margin: 0 !important;
    }
  </style>
</head>
<body>
  <canvas id="pixelCanvas" style="object-fit: contain;"></canvas>
  <script>
    /* Release canvas from memory */
    function releaseCanvas(canvas) {
      canvas.width = 1;
      canvas.style.width = "1vw";
      canvas.height = 1;
      canvas.style.height = "1vh";
      const ctx = canvas.getContext('2d');
      ctx && ctx.clearRect(0, 0, 1, 1);
      canvas.remove();
    }

    function getRandomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1) + min);
    }

    const canvas = document.getElementById("pixelCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = 768; // Width greater than height
    canvas.height = 480; // Adjust the height as desired
    canvas.style.width = "90vw";
    canvas.style.height = "90vh";

    // Constants for canvas dimensions
    const canvasWidth = 768; // Adjust the width as desired
    const maxCanvasHeight = 480; // Adjust the max height as desired
    canvas.width = canvasWidth;
    canvas.height = maxCanvasHeight;

    // Calculate the pixel size to fit the pattern within the canvas height
    const pixelSize = 8; // Adjusted to fit within the canvas height
    const rowLength = canvasWidth / pixelSize;
    const numSpaces = 10; // Variable for the number of spaces at each end
    const numRows = 59; // Variable for the number of rows, 59 max

    // Calculate the vertical offset to center the rug pattern vertically
    const patternHeight = numRows * pixelSize;
    const verticalOffset = (maxCanvasHeight - patternHeight) / 2;

    const color1 = "#FA239B";
    const color2 = "#DFC26B";
    const color3 = "#C0A8C5";
    const color4 = "#68EB2A";
    const color5 = "#291893";
    const color6 = "#7478BC";
    const color7 = "#D61D07";
    const color8 = "#ddfe43";
    const color9 = "#9A4EC0";
    const colors = [
      [color1, color2, color3],
      [color4, color5, color6],
      [color7, color8, color9]
    ];

    // Flatten and choose random colors
    const chosenColors = colors.flat().sort(() => 0.5 - Math.random()).slice(0, colors.length);
    const colorMap = chosenColors.reduce((map, color, index) => {
      map[index + 5] = color;
      return map;
    }, {9: 'transparent'});

    // Add color 10 to randomly pick from chosenColors
    colorMap[10] = chosenColors[Math.floor(Math.random() * chosenColors.length)];

    const rugPattern = generateRugPattern(numSpaces, numRows, rowLength);

    function generateRugPattern(numSpaces, numRows, rowLength) {
      const halfPattern = [];
      const halfNumRows = Math.ceil(numRows / 2);
      const centerRowIndex = Math.floor(numRows / 2);

      for (let row = 0; row < halfNumRows; row++) {
        const halfRowPattern = [];
        for (let col = 0; col < rowLength / 2; col++) {
          if (row === 0 || row === halfNumRows - 1) {
            halfRowPattern.push(10); // Solid color for top and bottom rows
          } else if (row % 2 === 0) {
            if (col < numSpaces) {
              halfRowPattern.push(10); // Solid color for the ends of even rows
            } else {
              halfRowPattern.push(getRandomInt(5, 5 + chosenColors.length - 1)); // Random pattern for the middle part of even rows
            }
          } else {
            if (col < numSpaces) {
              halfRowPattern.push(9); // Transparent for the ends of odd rows
            } else {
              halfRowPattern.push(getRandomInt(5, 5 + chosenColors.length - 1)); // Random pattern for the middle part of odd rows
            }
          }
        }
        const fullRowPattern = halfRowPattern.concat(halfRowPattern.slice().reverse());
        halfPattern.push(fullRowPattern);
      }

      // Adjust rows around the center for proper spacing
      const fullPattern = [];
      for (let row = 0; row < halfPattern.length - 1; row++) {
        fullPattern.push(halfPattern[row]);
      }

      // Add the center row with specific logic for spacing
      const centerRow = [];
      for (let col = 0; col < rowLength / 2; col++) {
        if ((numRows - 3) % 4 === 0) { // For odd numbers like 3, 7, 11...
          if (col < numSpaces) {
            centerRow.push(9); // Transparent for the ends of the center row
          } else {
            centerRow.push(getRandomInt(5, 5 + chosenColors.length - 1)); // Random pattern for the middle part of the center row
          }
        } else { // For odd numbers like 5, 9, 13...
          if (col < numSpaces) {
            centerRow.push(10); // Solid color for the ends of the center row
          } else {
            centerRow.push(getRandomInt(5, 5 + chosenColors.length - 1)); // Random pattern for the middle part of the center row
          }
        }
      }
      const fullCenterRow = centerRow.concat(centerRow.slice().reverse());
      fullPattern.push(fullCenterRow);

      for (let row = halfPattern.length - 2; row >= 0; row--) {
        fullPattern.push(halfPattern[row]);
      }

      return fullPattern.flat();
    }

    function getColorFromCode(code) {
      return colorMap[code];
    }

    function drawPixelArtRug() {
      for (let i = 0; i < rugPattern.length; i++) {
        const x = (i % rowLength) * pixelSize;
        const y = Math.floor(i / rowLength) * pixelSize + verticalOffset; // Apply vertical offset

        const color = getColorFromCode(rugPattern[i]);

        ctx.fillStyle = color;
        ctx.fillRect(x, y, pixelSize, pixelSize);
      }
    }

    drawPixelArtRug();

    // Single and double click actions
    let timer;
    document.querySelector("canvas").addEventListener('click', event => {
      if (event.detail === 1) {
        timer = setTimeout(() => {
          location.reload();
        }, 200)
      }
    });

    // Add double-click event listener to download the canvas as an image
    document.querySelector("canvas").addEventListener("dblclick", function () {
      clearTimeout(timer);
      const link = document.createElement('a');
      link.download = 'canvas.png';
      link.href = canvas.toDataURL();
      link.click();
    });
  </script>
</body>
</html>
