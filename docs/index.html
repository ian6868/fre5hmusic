<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebRTC Chat App</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; }
        .container { margin-top: 20px; }
        .button { padding: 10px 20px; margin: 10px; cursor: pointer; }
        .hidden { display: none; }
        .text-area { width: 100%; height: 100px; margin: 10px 0; padding: 10px; }
        #chatContainer { display: flex; flex-direction: column; width: 300px; }
        #messages { height: 200px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
        #inputField { padding: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container" id="initiate-section">
        <button id="hostButton" class="button">Host</button>
        <button id="joinButton" class="button">Join</button>

        <div id="offerSection" class="hidden">
            <textarea id="offerText" class="text-area" readonly></textarea>
            <button id="copyOfferButton" class="button">Copy Offer</button>
        </div>

        <div id="joinSection" class="hidden">
            <textarea id="joinOfferText" class="text-area" placeholder="Paste the offer here"></textarea>
            <button id="pasteOfferButton" class="button">Paste Offer</button>
            <button id="submitOfferButton" class="button">Join Chat</button>
        </div>
    </div>

    <div id="chatContainer" class="hidden">
        <div id="messages"></div>
        <input type="text" id="inputField" placeholder="Type a message..." />
        <button id="sendButton" class="button">Send</button>
    </div>

    <script>
        const hostButton = document.getElementById('hostButton');
        const joinButton = document.getElementById('joinButton');
        const offerSection = document.getElementById('offerSection');
        const offerText = document.getElementById('offerText');
        const copyOfferButton = document.getElementById('copyOfferButton');
        const joinSection = document.getElementById('joinSection');
        const joinOfferText = document.getElementById('joinOfferText');
        const pasteOfferButton = document.getElementById('pasteOfferButton');
        const submitOfferButton = document.getElementById('submitOfferButton');
        const chatContainer = document.getElementById('chatContainer');
        const messagesDiv = document.getElementById('messages');
        const inputField = document.getElementById('inputField');
        const sendButton = document.getElementById('sendButton');

        let localConnection;
        let dataChannel;
        let isHost = false;

        const iceServers = {
            iceServers: [
                { urls: 'stun:iphone-stun.strato-iphone.de:3478' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:stun4.l.google.com:19302' }
            ]
        };

        const setupConnection = async (isHost) => {
            localConnection = new RTCPeerConnection(iceServers);

            localConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    console.log('ICE Candidate:', JSON.stringify(event.candidate));
                } else {
                    console.log('All ICE candidates have been sent');
                    if (localConnection.localDescription) {
                        offerText.value = JSON.stringify(localConnection.localDescription);
                        offerSection.classList.remove('hidden');
                    }
                }
            };

            localConnection.onconnectionstatechange = () => {
                console.log('Connection State:', localConnection.connectionState);
                if (localConnection.connectionState === 'connected') {
                    console.log('WebRTC connection established.');
                    switchToChat();
                } else if (localConnection.connectionState === 'failed' || localConnection.connectionState === 'disconnected') {
                    console.log('WebRTC connection failed or disconnected. State:', localConnection.connectionState);
                }
            };

            localConnection.ondatachannel = (event) => {
                dataChannel = event.channel;
                dataChannel.onopen = () => {
                    console.log('Remote data channel opened');
                    switchToChat();
                };
                dataChannel.onmessage = (event) => handleMessage(event.data);
            };

            if (isHost) {
                dataChannel = localConnection.createDataChannel('chat');
                dataChannel.onopen = () => {
                    console.log('Local data channel opened');
                    switchToChat();
                };
                dataChannel.onmessage = (event) => handleMessage(event.data);

                const offer = await localConnection.createOffer();
                await localConnection.setLocalDescription(offer);
                console.log('Created Offer', offer);
            }
        };

        const handleOffer = async (offer) => {
            try {
                const parsedOffer = JSON.parse(offer);
                console.log('Parsed Offer:', parsedOffer);
                await setupConnection(false);
                await localConnection.setRemoteDescription(new RTCSessionDescription(parsedOffer));

                const answer = await localConnection.createAnswer();
                await localConnection.setLocalDescription(answer);
                console.log('Created Answer', answer);

                // Wait for ICE candidate gathering to complete
                await new Promise(resolve => {
                    localConnection.onicegatheringstatechange = () => {
                        if (localConnection.iceGatheringState === 'complete') {
                            resolve();
                        }
                    };
                });

                switchToChat();
            } catch (err) {
                alert('Error Handling Offer: ' + err);
                console.error(err);
            }
        };

        const switchToChat = () => {
            document.getElementById('initiate-section').classList.add('hidden');
            chatContainer.classList.remove('hidden');
        };

        const handleMessage = (data) => {
            const messageElement = document.createElement('div');
            messageElement.textContent = data;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        };

        hostButton.addEventListener('click', async () => {
            isHost = true;
            await setupConnection(true);
        });

        joinButton.addEventListener('click', () => {
            joinSection.classList.remove('hidden');
        });

        copyOfferButton.addEventListener('click', () => {
            offerText.select();
            document.execCommand('copy');
            alert('Offer copied to clipboard');
        });

        pasteOfferButton.addEventListener('click', async () => {
            try {
                const text = await navigator.clipboard.readText();
                joinOfferText.value = text;
            } catch (err) {
                alert('Clipboard Read Error: ' + err);
                console.error(err);
            }
        });

        submitOfferButton.addEventListener('click', async () => {
            const offer = joinOfferText.value.trim();
            await handleOffer(offer);
        });

        sendButton.addEventListener('click', () => {
            if (inputField.value.trim() && dataChannel && dataChannel.readyState === 'open') {
                const message = inputField.value.trim();
                dataChannel.send(message);
                inputField.value = '';

                const messageElement = document.createElement('div');
                messageElement.textContent = message;
                messagesDiv.appendChild(messageElement);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            } else {
                console.log('Data Channel Not Open or Empty Message');
            }
        });

        inputField.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendButton.click();
            }
        });
    </script>
</body>
</html>
